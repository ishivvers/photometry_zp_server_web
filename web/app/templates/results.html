{% extends "base.html" %}

{% block active2 %} class="active" {% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row-fluid">
    <div class="span4">
      <div class="well sidebar-nav pre-scrollable">
        <ul class="nav nav-list">
          <li class="nav-header">Sources (RA,DEC)</li>
		  <!-- add class="active" to add highlighting -->
		  {% for spec_id in spec_ids %}
            <li id="source_{{loop.index-1}}"><a href="#" onclick="draw_spectrum({{ spec_id }}, {{ loop.index-1 }})"> ({{ coords[loop.index-1][0] }}, {{ coords[loop.index-1][1] }}) </a></li>
		  {% endfor %}
        </ul>
      </div><!--/.well -->
    </div><!--/span-->
    <div class="span8">
      <div class="hero-unit" id="main_hero">
		<!-- draw our line plot -->
      </div>
      <div class="row-fluid">
        <div class="span4" id="feedback1">
          <h2>Magnitudes</h2>
			<table class="table table-condensed">
				<tr><td><b>Band</b></td>
					<td><b>Mag</b></td>
					<td><b>&sigma;</b></td>
					<td><b>Modeled?</b></td></tr>
				<tr id='tr_u'><td><b>u</b></td>
					<td>-</td><td>-</td><td>-</td></tr>
				<tr id='tr_g'><td><b>g</b></td>
					<td>-</td><td>-</td><td>-</td></tr>
				<tr id='tr_r'><td><b>r</b></td>
					<td>-</td><td>-</td><td>-</td></tr>
				<tr id='tr_i'><td><b>i</b></td>
					<td>-</td><td>-</td><td>-</td></tr>
				<tr id='tr_z'><td><b>z</b></td>
					<td>-</td><td>-</td><td>-</td></tr>
				<tr id='tr_y'><td><b>y</b></td>
					<td>-</td><td>-</td><td>-</td></tr>
				<tr id='tr_B'><td><b>B</b></td>
					<td>-</td><td>-</td><td>-</td></tr>
				<tr id='tr_R'><td><b>R</b></td>
					<td>-</td><td>-</td><td>-</td></tr>
				<tr id='tr_J'><td><b>J</b></td>
					<td>-</td><td>-</td><td>-</td></tr>
				<tr id='tr_H'><td><b>H</b></td>
					<td>-</td><td>-</td><td>-</td></tr>
				<tr id='tr_K'><td><b>K</b></td>
					<td>-</td><td>-</td><td>-</td></tr>
			</table>
        </div><!--/span-->
        <div class="span8">
          <h2>Catalog</h2>
			<p>
				Click below to download a full computer-readable (tab-separated) ASCII catalog,
				including all magnitudes and errors, for these sources.
			</p>
			<form method="get" action="{{ url_for('serve_full_catalog') }}">
			<input type="submit" class="btn btn-primary btn-small" value="Download"/>
			</form>
        </div><!--/span-->
      </div><!--/row-->
    </div><!--/span-->
  </div><!--/row-->
</div><!--/container-->

<!-- Load all js -->
<script src="static/d3.v2.js"></script>

<!-- THE PLOTS -->
<script type="text/javascript">

// margins & size
var margin = {top: 10, right: 10, bottom: 20, left: 65},
    width = 600 - margin.left - margin.right,
    height = 300 - margin.top - margin.bottom;

// scales
var xScale = d3.scale.log()
    .range([0, width]);
var yScale = d3.scale.linear()
    .range([height, 0]);

// axis generators
var xAxis = d3.svg.axis()
    .scale(xScale)
    .orient("bottom")
	.tickValues( [3000,4000,5000,6000,8000,10000,15000,20000] )
	.tickFormat(d3.format("d"));
var yAxis = d3.svg.axis()
    .scale(yScale)
    .orient("left")
	.ticks(5)
	.tickFormat(d3.format(".1e"));
	
// a line generator, called below
var line = d3.svg.line()
    .x(function(d) { return xScale(d.x); })
    .y(function(d) { return yScale(d.y); });

// the main image -- data added below in json call
var svg = d3.select("#main_hero").append("svg")
    .attr("height", "50%")
    .attr("width", "100%")
	.attr("viewBox", "0 0 600 300")
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");	

// insert the (empty) lines and axes into svg
svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")");
svg.append("g")
    .attr("class", "y axis");
svg.append("path")
    .attr("class", "line");
// axis labels, invisible until plot is drawn
svg.append("text")
	.attr("class", "x label")
	.attr("text-anchor", "end")
	.attr("x", width-5)
	.attr("y", height-8)
	.text("wavelength (A)")
	.attr("opacity", 0.0);
svg.append("text")
	.attr("class", "y label")
	.attr("text-anchor", "end")
	.attr("y", 12)
	.attr("transform", "rotate(-90)")
	.text("Flux (erg/s/cm^2/A)")
	.attr("opacity", 0.0);

// create a variable to contain the displayed SED (used below)
var SED = svg.append("svg:g")
             .attr("id", "SED");

// some feedback text so user knows what to do next
svg.append("text")
    .attr("class", "loading")
    .text("Choose a source to inspect...")
    .attr("x", function () { return width/2-125; })
    .attr("y", function () { return height/2; });

function draw_spectrum( spec_id, sed_index ) {
	// remove the loading text:
	svg.selectAll(".loading").remove();
	
	// if there are already circles around, remove them
	svg.selectAll(".circle").remove();
	
	// put in the line plot with a json call to serve_spectrum:
	d3.json( "{{ url_for('serve_spectrum') }}?spec="+String(spec_id)+"&index="+String(sed_index), function(data) {
		// parse the domains, and put into the scales
		xScale.domain([ d3.min(data, function(d){return d.x;}), d3.max(data, function(d){return d.x;}) ]);
		yScale.domain([ d3.min(data, function(d){ return d.y;}), d3.max(data, function(d){return d.y;}) ]);

		// bind the data to our line plot, using the line generator above
		svg.select("path.line").data( [data] );

		// finally, draw the image
		draw();
	});
	
	// now insert the scatterplot with a json call to serve_mags
	d3.json( "{{ url_for('serve_sed_flams') }}?index="+String(sed_index), function(data) {
		svg.selectAll("circle")
			.data(data).enter().append("circle")
			.attr("class", "circle")
			.attr("cx", function(d) { return xScale(d.x);})
			.attr("cy", function(d) { return yScale(d.y);})
			.transition()
			  .delay(400)
	          .duration(400)
			  .attr("r", 8);
			
		// redraw the image
		draw();
	})
	
	// now update the text below
	update_text(sed_index);
};

function draw() {
	svg.select("g.x.axis").call(xAxis);
	svg.select("g.y.axis").call(yAxis);
	svg.selectAll(".label").attr("opacity",1.0);
	svg.select("path.line")
		.transition()
        .duration(400)
		.attr("d", line);
}

// function to change the body text, displaying feedback for selected source
function update_text(sed_index) {
	// first set the selected source as active
	//  remove active class from previous selection, and apply it to new selection
	var all_active_elements = document.getElementsByClassName("active");
	for (var i=0; i<all_active_elements.length; i++) { 
		if (all_active_elements[i].id !='') { // if id='', then this is a top navbar element
			all_active_elements[i].className = "";
		};
	};
	var list_element = document.getElementById("source_"+String(sed_index));
	list_element.className = "active";
	
	// then update the magnitudes table
	var xmlhttp=new XMLHttpRequest();
	xmlhttp.onreadystatechange=function() {
	  if (xmlhttp.readyState==4 && xmlhttp.status==200) {
			eval("var reply="+xmlhttp.responseText);
			for (var i=0; i<reply.length; i++) {
				var cells = document.getElementById("tr_"+reply[i].name).childNodes;
				cells[2].childNodes[0].replaceData( 0, 10, reply[i].y.toFixed(2));
				cells[3].childNodes[0].replaceData( 0, 10, reply[i].err.toFixed(3));
				cells[4].childNodes[0].replaceData( 0, 10, reply[i].modeled);
	        };
	  };
	};
	xmlhttp.open("GET","{{ url_for('serve_sed_mags') }}?index="+String(sed_index),true);
	xmlhttp.send();
};
</script>

{% endblock %}
