{% extends "base.html" %}

{% set page_title = 'Results.' %}

{% block content %}
<div class="container-fluid">
  <div class="row-fluid">
    <div class="span4">
      <div class="well sidebar-nav pre-scrollable">
        <ul class="nav nav-list">
          <li class="nav-header">Sources (RA,DEC)</li>
		  <!-- add class="active" to add highlighting -->
		  {% for spec_id in spec_ids %}
            <li><a href="#" onclick="draw_spectrum({{ spec_id }}, {{ loop.index-1 }})"> ({{ coords[loop.index-1][0] }}, {{ coords[loop.index-1][1] }}) </a></li>
		  {% endfor %}
        </ul>
      </div><!--/.well -->
    </div><!--/span-->
    <div class="span8">
      <div class="hero-unit" id="main_hero">
		<!-- draw our line plot -->
      </div>
      <div class="row-fluid">
        <div class="span4">
          <h2>Zeropoint Estimates</h2>
          <p>Here, I'll include the calculated ZP estimate, if given instrumental mags and a band
	         on the previous page.  Also include info for each band of the given source.</p>
        </div><!--/span-->
        <div class="span8">
          <h2>Histogram</h2>
		  <p>Put a histogram here (if given instrumental mags).  Otherwise, include and image
			 of the selected source.</p>
        </div><!--/span-->
      </div><!--/row-->
    </div><!--/span-->
  </div><!--/row-->
</div><!--/container-->

<!-- Load all js -->
<script src="static/d3.v2.js"></script>

<!-- THE LINE PLOT -->
<script type="text/javascript">

// the bands we use:
var band_names = ['u','g','r','i','z','y','B','R','J','H','K']
    band_wl    = [3551., 4686., 6165., 7481., 8931., 10091., 4400., 6500., 12350., 16620., 21590.];

// margins & size
var margin = {top: 10, right: 10, bottom: 20, left: 65},
    width = 600 - margin.left - margin.right,
    height = 300 - margin.top - margin.bottom;

// scales
var xScale = d3.scale.log()
    .range([0, width]);
var yScale = d3.scale.linear()
    .range([height, 0]);

// axis generators
var xAxis = d3.svg.axis()
    .scale(xScale)
    .orient("bottom")
	.tickValues( band_wl )
	.tickFormat( function(d,i) { console.log(i); return band_names[i];} );
var yAxis = d3.svg.axis()
    .scale(yScale)
    .orient("left")
	.ticks(5)
	.tickFormat(d3.format(".1e"));
	
// a line generator, called below
var line = d3.svg.line()
    .x(function(d) { return xScale(d.x); })
    .y(function(d) { return yScale(d.y); });

// the main image -- data added below in json call
var svg = d3.select("#main_hero").append("svg")
    .attr("height", "50%")
    .attr("width", "100%")
	.attr("viewBox", "0 0 600 300")
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");	

// insert the (empty) lines and axes into svg
svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")");
svg.append("g")
    .attr("class", "y axis");
svg.append("path")
    .attr("class", "line");

// some feedback text so user knows what to do next
svg.append("text")
    .attr("class", "loading")
    .text("Choose a source to inspect...")
    .attr("x", function () { return width/2-125; })
    .attr("y", function () { return height/2; });

function draw_spectrum( spec_id, sed_index ) {
	// remove the loading text:
	svg.selectAll(".loading").remove();
	
	// if there are already circles around, remove them
	svg.selectAll(".circle").remove();
	svg.selectAll(".labels").remove();
	
	// put in the line plot with a json call to serve_spectrum:
	d3.json( "{{ url_for('serve_spectrum') }}?spec="+String(spec_id)+"&index="+String(sed_index), function(data) {
		// parse the domains, and put into the scales
		xScale.domain([ d3.min(data, function(d){return d.x;}), d3.max(data, function(d){return d.x;}) ]);
		yScale.domain([ d3.min(data, function(d){ return d.y;}), d3.max(data, function(d){return d.y;}) ]);

		// bind the data to our line plot, using the line generator above
		svg.select("path.line").data( [data] );

		// finally, draw the image
		draw();
	});
	
	// now insert the scatterplot with a json call to serve_mags
	d3.json( "{{ url_for('serve_mags') }}?index="+String(sed_index), function(data) {
		svg.selectAll("circle")
			.data(data).enter().append("circle")
			.attr("class", "circle")
			.attr("cx", function(d) { return xScale(d.x);})
			.attr("cy", function(d) { return yScale(d.y);})
			.transition()
			  .delay(400)
	          .duration(400)
			  .attr("r", 8);
			
		// redraw the image
		draw();
	})
};

function draw() {
	svg.select("g.x.axis").call(xAxis);
	svg.select("g.y.axis").call(yAxis);
	svg.select("path.line")
		.transition()
        .duration(400)
		.attr("d", line);
}
</script>

{% endblock %}
